default_platform(:ios)

before_all do
  sh 'mkdir ../reports || true'
  sh 'mkdir ../dist || true'
end

desc "Does a static analysis of the project. Configure the options in .swiftlint.yml"
lane :lint do
  swiftlint(
      mode: :lint,
      output_file: 'reports/swiftlint.txt',
      config_file: '.swiftlint.yml'
    )
end

desc "Create a file with the Changelog output between a specific TAG and HEAD"
lane :changelog do |options|
changelog_from_git_commits(
	between: [options[:tag],"HEAD"],
  	pretty: "* %b [%aN]",# Optional, lets you provide a custom format to apply to each commit when generating the changelog text
  	date_format: "short",# Optional, lets you provide an additional date format to dates within the pretty-formatted string
  	match_lightweight_tag: false,  # Optional, lets you ignore lightweight (non-annotated) tags when searching for the last tag
  	merge_commit_filtering: "only_include_merges" # Optional, lets you filter out merge commits
)
#store changelog in a external file
changelog = lane_context[SharedValues::FL_CHANGELOG]
File.open("changelog.txt", 'w') { |file| file.write("#{changelog}") }

end

platform :ios do
  desc "Run tests for TelnyxVoiceAIWidget SDK"
  lane :test_sdk do
    UI.message("ðŸ”¨ Building and testing TelnyxVoiceAIWidget framework...")

    xcodebuild(
      workspace: "TelnyxVoiceAIWidget.xcworkspace",
      scheme: "TelnyxVoiceAIWidget",
      configuration: "Debug",
      destination: "platform=iOS Simulator,name=iPhone 16",
      clean: true,
      build: true
    )

    UI.success("âœ… SDK build completed successfully!")
  end

  desc "Run tests for SampleApp"
  lane :test_sample_app do
    UI.message("ðŸ”¨ Building and testing SampleApp...")

    xcodebuild(
      workspace: "TelnyxVoiceAIWidget.xcworkspace",
      scheme: "SampleApp",
      configuration: "Debug",
      destination: "platform=iOS Simulator,name=iPhone 16",
      clean: true,
      build: true
    )

    UI.success("âœ… SampleApp build completed successfully!")
  end

  desc "Run all tests (SDK + SampleApp)"
  lane :tests do
    test_sdk
    test_sample_app
    UI.success("âœ… All tests completed successfully!")
  end

  desc "Build TelnyxVoiceAIWidget framework only"
  lane :build_sdk do
    xcodebuild(
      workspace: "TelnyxVoiceAIWidget.xcworkspace",
      scheme: "TelnyxVoiceAIWidget",
      configuration: "Debug",
      destination: "platform=iOS Simulator,name=iPhone 16",
      clean: true,
      build: true
    )
  end

  desc "Build SampleApp only"
  lane :build_sample_app do
    xcodebuild(
      workspace: "TelnyxVoiceAIWidget.xcworkspace",
      scheme: "SampleApp",
      configuration: "Debug",
      destination: "platform=iOS Simulator,name=iPhone 16",
      clean: true,
      build: true
    )
  end

  desc "Run SwiftLint and all tests"
  lane :ci do
    lint
    tests
    UI.success("âœ… CI pipeline completed successfully!")
  end

  desc "Build framework for release"
  lane :build_release do
    UI.message("ðŸ”¨ Building TelnyxVoiceAIWidget for release...")
    
    xcodebuild(
      workspace: "TelnyxVoiceAIWidget.xcworkspace",
      scheme: "TelnyxVoiceAIWidget",
      configuration: "Release",
      destination: "generic/platform=iOS",
      clean: true,
      build: true,
      archive: true,
      archive_path: "dist/TelnyxVoiceAIWidget.xcarchive"
    )
    
    UI.success("âœ… Release build completed successfully!")
  end

  desc "Prepare release - lint, test, and build"
  lane :prepare_release do
    lint
    tests
    build_release
    UI.success("âœ… Release preparation completed successfully!")
  end

  desc "Generate documentation using Jazzy - HTML docs"
  lane :generate_docs do
    # Use configuration file to avoid command-line escaping issues
    sh <<-SHELL
      cd .. && jazzy --config .jazzy.yaml
    SHELL
    UI.message("ðŸ“š Documentation generated in ./docs")
  end

  desc "Generate documentation using SourceDocs - Markdown docs"
  lane :generate_docs_markdown do
    sh <<-SHELL
      cd .. && sourcedocs generate --output-folder ./docs-markdown \
                                -- \
                                -workspace TelnyxVoiceAIWidget.xcworkspace \
                                -scheme TelnyxVoiceAIWidget \
                                -destination 'platform=iOS Simulator,OS=18.5,name=iPhone 16 Pro Max'


    SHELL
    UI.message("ðŸ“„ Markdown documentation generated in ./docs-markdown")
  end

  desc "Generate HTML and Markdown documentation"
  lane :generate_full_docs do
    generate_docs
    generate_docs_markdown
    UI.success("âœ… Documentation successfully generated and converted to Markdown")
  end
end