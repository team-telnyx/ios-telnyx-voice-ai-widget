default_platform(:ios)

before_all do
  sh 'mkdir ../reports || true'
end

platform :ios do
  desc "Run tests for TelnyxVoiceAIWidget SDK"
  lane :test_sdk do
    UI.message("ðŸ”¨ Building and testing TelnyxVoiceAIWidget framework...")

    xcodebuild(
      workspace: "TelnyxVoiceAIWidget.xcworkspace",
      scheme: "TelnyxVoiceAIWidget",
      configuration: "Debug",
      destination: "platform=iOS Simulator,name=iPhone 16",
      clean: true,
      build: true
    )

    UI.success("âœ… SDK build completed successfully!")
  end

  desc "Run tests for SampleApp"
  lane :test_sample_app do
    UI.message("ðŸ”¨ Building and testing SampleApp...")

    xcodebuild(
      workspace: "TelnyxVoiceAIWidget.xcworkspace",
      scheme: "SampleApp",
      configuration: "Debug",
      destination: "platform=iOS Simulator,name=iPhone 16",
      clean: true,
      build: true
    )

    UI.success("âœ… SampleApp build completed successfully!")
  end

  desc "Run all tests (SDK + SampleApp)"
  lane :tests do
    test_sdk
    test_sample_app
    UI.success("âœ… All tests completed successfully!")
  end

  desc "Build TelnyxVoiceAIWidget framework only"
  lane :build_sdk do
    xcodebuild(
      workspace: "TelnyxVoiceAIWidget.xcworkspace",
      scheme: "TelnyxVoiceAIWidget",
      configuration: "Debug",
      destination: "platform=iOS Simulator,name=iPhone 16",
      clean: true,
      build: true
    )
  end

  desc "Build SampleApp only"
  lane :build_sample_app do
    xcodebuild(
      workspace: "TelnyxVoiceAIWidget.xcworkspace",
      scheme: "SampleApp",
      configuration: "Debug",
      destination: "platform=iOS Simulator,name=iPhone 16",
      clean: true,
      build: true
    )
  end
end